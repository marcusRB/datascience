---
title: "EDA - Uber Peru"
author: "Marco Russo"
date : "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
  fig_caption: yes
number_sections: yes
smart: no
theme: spacelab
toc_float: yes
pdf_document:
  highlight: zenburn
toc: yes
word_document: default
html_notebook: 
  code_folding: hide
editor_options: 
  chunk_output_type: inline
code_folding: show
---
  
# Exercise 1

***
## About TeLlevo

TeLlevo is a mobility startup that lets any user to book a ride to from any point A to any point B  within the city using a smartphone. Ride value is calculated at the time of request automatically  by the app, considering distance, estimated travel time, and current car availability (demand /  offer balance). Once the ride ends, we charge passenger's credit card, and transfer 75% of this  value to the driver's bank account. Finally, before the passengers gets picked up, the ride can be  cancelled by either the driver or the passenger.  


***
## Description  
Attached to this email you can find a dataset that contains the first year of TeLlevo journeys.  Please, complete the two steps analysis:  

1. A descriptive data analysis. Please, answer questions like:  ○ how many? (e.g: vehicles, riders, drivers)  ○ when? (e.g: journeys/price/cost per time period, are the journeys quick?  ○ what? (e.g: reservations/asap, vehicle type)  ○ where? (e.g: origin map, best origins)  ○ who? (e.g: worst riders, best drivers)  ○ any question you consider interesting

2. At least 3 business recommendations based on your previous analysis. Feel free to  recommend anything you want, we ask you only one thing: each recommendation must  be supported by data! 


***
## Tips & Hints:

- Use any tool you want: Tableau (we use it intensively!), Qlik, Python/R notebooks, Power BI, Excel, Carto…
- We are going to check not only if you know how to make a meaningful analysis but also if you know how to explain it.
- If you have any doubt ping us!



***
## Load packages and libraries
  
```{r, echo=FALSE, message=FALSE}
# Carga de las librerías
library(tidyverse)
library(readxl)
library(knitr)
library(ggplot2)
library(lubridate)
library(ggplot2)
library(dplyr)
library(scales)
library(tidyr)
library(DT)
library(ggthemes)

```


## Load dataset and show structure


```{r, echo=FALSE, message=FALSE}
# Load the dataset and set main variable name
library("readxl")
dataset <- readxl::read_excel("Uber_2010.xlsx")

# Dim function is important to list our dataset
dim(dataset)


# check only a sample of 10 results and the first 14 variables
head(dataset[0:14], 10)
head(dataset[15:28], 10)

```

Dataset *Uber_2010* has 23111 observations and 28 variables

Now, we check the structure of each variable

```{r, message = FALSE, echo = FALSE}
# Check the structure of dataset
str(dataset)
```

Uber2010 dataset has structured:
**journey_id** string , alphanumerical id of rider
**user_id** string, alphanumerical id of customer
**driver_id** string, alphanumerical id of driver
**taxi_id** string, alphanumerical id of vehicle
**icon** string, vehicle type
**start_type** string, how customer ask uber service
**start_at** date, format YYYY-MM-DD HH:mm:ss referr timezone of Spain (I check it later!)
**start_lat** and **start_lon** numerical, latitude and longitude of start of journey
**end_at** date, referr timezone of Spaing
**end_lat** and **end_lon** numerical, latitude and longitude of the end of journey
**end_state** string, how journey terminate
**price** numerical value of price of distance, duration and total
**cost** numerical value of cost of distance, duration and total
**distance** numerical value of distance of journey expressed in meters
**duration** numerical value of duration of journey expressed in seconds
**source** string, value that indicate of type of device
**driver_score** and **rider_score** numerical values about 1 to 5 scoring sent by customer.

***
## Data Cleaning and Preparation
  
After loading the dataset, second step is very important to format the variable, dates or create new ones.


```{r, message = FALSE, echo = FALSE}
# We analyze all null values
table(is.na(dataset))
na_values <- sum(is.na(dataset) == TRUE)
false_naValues <- sum(is.na(dataset) == FALSE)

sprintf("The are %d null values in our dataset", na_values)

sprintf("The quota of null values in our dataset is %f", ((na_values*100)/sum(na_values,false_naValues)))
```




```{r, message = FALSE, echo = FALSE}
# Procederemos a analizar los valores nulos del dataset transaction
summary(is.null(dataset$Date))
str(is.null(dataset$Transaction))
```


```{r, message = FALSE, echo = FALSE}
# Check the general stats for all variables
summary(na.omit(dataset))
```



***
### Data Preparation
  
Add time, weekday and months variables from dates columns: start_at, end_at, arrived_at

```{r, message = FALSE, echo = FALSE}
# Create new dataset > uber2010
uber2010 <- dataset

# Add new variables
uber2010$day <- format(uber2010$start_at, "%d")
uber2010$month <- format(uber2010$start_at, "%m")
uber2010$year <- format(uber2010$start_at, "%Y")
uber2010$hour <- format(uber2010$start_at, "%H")
uber2010$weekday <- weekdays(uber2010$start_at)

# check new structure again and the header
head(uber2010[0:14], 10)
head(uber2010[15:33], 10)
```



***
## EDA Exploratory Data Analysis

Check first observations about how many vehicles, riders, drivers there are in this dataset.


```{r, message = FALSE, echo = FALSE}
# Create main variables
taxi <- na.omit(length(unique(uber2010$taxi_id)))
riders <- na.omit(length(unique(uber2010$journey_id)))
drivers <- na.omit(length(unique(uber2010$driver_id)))
customers <- na.omit(length(unique(uber2010$user_id)))


# Check unique vehicles, riders and drivers
sprintf("Uber2010 dataset has %d unique vehicles...", taxi)
sprintf("...for %d unique riders.", riders)
sprintf("There are %d unique drivers...", drivers)
sprintf("that offer service at %d unique different customers", customers)
sprintf("We have %f drivers per each vehicle", round(riders/taxi)-100)

```


## Check how many riders by hour, weekday and month

```{r, message = FALSE, echo = FALSE}
# Check unique vehicles, riders and drivers

by_hour <- uber2010 %>%
  group_by(hour) %>%
    dplyr::summarize(Total = n()) 
datatable(by_hour)

ggplot(by_hour, aes(hour, Total)) + 
            geom_bar( stat = "identity", fill = "darkgreen") +
                  ggtitle("Trips Every Hour") +
                    theme(legend.position = "none") +
                    scale_y_continuous(labels = comma)

by_month_hour <- uber2010 %>%
                  group_by(month, hour) %>%
                        dplyr::summarize(Total = n()) 

ggplot(by_month_hour, aes(hour, Total, fill = month)) + 
            geom_bar( stat = "identity") +
                  ggtitle("Trips by Hour and Month") +
                    scale_y_continuous(labels = comma)
```

As I discovered in other notebooks of mine, Jupyter of Python, Tableau, I saw the peak hour a little bit rare of a typical country or metropolitan area, like as Peru. So I checked and I transform data of start_at and end_at from Europe/CET or CEST (summer time and winter time by Madrid are 6/7 hour of difference) to Peru Time Zone PTZ (instead Pacific I called PeruTimeZone).


***

Timezone Conversion


```{r, message = FALSE, echo = FALSE}
# I copy/past backup main dataset
uber2010bak <- uber2010

# Check start_at variable and assign CET/CEST timezone
head(uber2010bak$start_at,10)
uber2010bak$start_at_ptz <- as.POSIXct(uber2010bak$start_at, tz="Europe/Madrid")

# Transform start_at to Peru Timezone
attributes(uber2010bak$start_at_ptz)$tzone <- "America/Lima"  

# check again the transformation vs the previous conversion
head(uber2010bak$start_at_ptz,10)



# Add new variables attached _ptz prefix
uber2010bak$day_ptz <- format(uber2010bak$start_at_ptz, "%d")
uber2010bak$month_ptz <- format(uber2010bak$start_at_ptz, "%m")
uber2010bak$year_ptz <- format(uber2010bak$start_at_ptz, "%Y")
uber2010bak$hour_ptz <- format(uber2010bak$start_at_ptz, "%H")

```


Let's show again journeys by hour

```{r, message = FALSE, echo = FALSE}
# Check unique vehicles, riders and drivers

by_hour <- uber2010bak %>%
  group_by(hour_ptz) %>%
    dplyr::summarize(Total = n()) 
datatable(by_hour)

ggplot(by_hour, aes(hour_ptz, Total)) + 
            geom_bar( stat = "identity", fill = "darkgreen") +
                  ggtitle("Trips Every Hour") +
                    theme(legend.position = "none") +
                    scale_y_continuous(labels = comma)

by_month_hour <- uber2010bak %>%
                  group_by(month_ptz, hour_ptz) %>%
                        dplyr::summarize(Total = n()) 

ggplot(by_month_hour, aes(hour_ptz, Total, fill = month_ptz)) + 
            geom_bar( stat = "identity") +
                  ggtitle("Trips by Hour and Month") +
                    scale_y_continuous(labels = comma)
```


Done! Now the graphs have make sense, peak hour is 8am and after 5pm






```{r, message = FALSE, echo = FALSE}

by_month <- uber2010bak %>%
                  group_by(month_ptz) %>%
                        dplyr::summarize(Total = n()) 
datatable(by_month)

ggplot(by_month, aes(month_ptz, Total, fill = month_ptz)) + 
            geom_bar( stat = "identity") +
                  ggtitle("Trips by Month") +
                    theme(legend.position = "none") +
                    scale_y_continuous(labels = comma)

by_month_weekday <- uber2010bak %>%
                  group_by(month_ptz, weekday) %>%
                        dplyr::summarize(Total = n()) 

ggplot(by_month_weekday, aes(month_ptz, Total, fill = weekday)) + 
            geom_bar( stat = "identity", position = "dodge") +
                  ggtitle("Trips by Day and Month") +
                    scale_y_continuous(labels = comma)

```

In 2010 journeys has been increased after september (South America has season inverted, so last quarter is Summer there).





### Number of Trips by Weekday 

```{r eval=FALSE, message=FALSE, include=FALSE}
datatable(uber2010bak %>% 
              group_by(weekday) %>% 
                dplyr::summarize(Total = sum(journey_id)))

ggplot(uber2010bak, aes(weekday, trips, fill = dayofweek)) + 
            geom_bar( stat = "identity") +
                  ggtitle("Uber trips by Weekday of the Month") +
                    theme(legend.position = "none") +
                    scale_y_continuous(labels = comma) +
                    scale_fill_manual(values = mycolors)

ggplot(uber2010bak, aes(weekday, trips, fill = month)) + 
            geom_bar(stat = "identity", position = "dodge") +
                  ggtitle("Uber trips by Weekday and Month") +
                    scale_y_continuous(labels = comma) +
                    scale_fill_manual(values = mycolors)

```


```{r, message = FALSE, echo = FALSE}
# Riders by hour all months included
uber2010$hour <- as.factor(uber2010$hour)
a <- hms(as.character(uber2010$hour))
uber2010$hour = hour(a)

uber2010 %>%
  ggplot(aes(x=hour)) + 
  geom_histogram(stat="count",fill="dark grey")+
  labs(title="Riders by hour") +
  theme_bw()

```

> We see peak pickup at 1pm and after 10pm

```{r, message = FALSE, echo = FALSE}
# Riders by day of week all months included
uber2010$weekday <- factor(uber2010$weekday, levels=c("lunes","martes","miércoles","jueves","viernes","sábado","domingo"))
uber2010 %>%
  group_by(weekday) %>%
  ggplot(aes(x=weekday, fill=weekday)) + 
  geom_histogram(stat="count",fill="dark grey", show.legend = FALSE)+
  labs(title="Riders by day of the wee") +
  theme_bw()

```

> Con más volumen de venta duranta la semana tenemos a partir del jueves un crecimiento en las ventas, con sábado día de más ventas, seguidas por el viernes y domingo.



```{r, message = FALSE, echo = FALSE}
# Transacciones por mes del año
uber2010$month <- as.factor(uber2010$month)
uber2010 %>% 
  ggplot(aes(x=month)) + 
  geom_histogram(stat="count", fill="dark grey")+
  labs(title="Transacciones por mes del año") +
  theme_bw()

```

> We see increased riders from august to december.




***
### Map coordinates
  
Next, let’s explore lat/lon values. Starting with a simple plot of pickup coordinates:

```{r, message = FALSE, echo = FALSE}
# Plot start of journey
ggplot(uber2010bak, aes(start_lon,start_lat)) + geom_point(alpha = .06, size=0.5, colour="blue") 
```


```{r, message = FALSE, echo = FALSE}
# Plot the end of journey
ggplot(uber2010bak, aes(end_lon, end_lat)) + geom_point(alpha = .06, size=0.5, colour="red") 
```







